<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Music Taste Matcher - Find Your Twin</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
  </head>
  <body>
    <div class="background"></div>
    <canvas id="particles"></canvas>

    <div class="container">
      <div class="header">
        <h1>üéµ MUSIC TASTE MATCHER</h1>
        <p class="subtitle">FIND YOUR SONIC TWIN</p>
      </div>

      <!-- Welcome Screen -->
      <div id="welcomeScreen" class="welcome-screen">
        <div class="question-card purple-hover">
          <h2>Ready to find your music taste twin?</h2>
          <p>
            Answer 6 quick questions and we'll match you with someone who shares
            your musical DNA.
          </p>
          <button class="btn-start" onclick="startQuestionnaire()">
            BEGIN JOURNEY
          </button>
        </div>
      </div>

      <!-- Progress Bar -->
      <div id="progressContainer" class="progress-container hidden">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <!-- Question Card -->
      <div id="questionCard" class="question-card purple-hover hidden">
        <div class="question-number" id="questionNumber">QUESTION 1/6</div>
        <div class="question-text" id="questionText"></div>
        <div class="question-hint" id="questionHint"></div>

        <div class="input-wrapper">
          <textarea
            id="answerInput"
            placeholder="Type your answer here..."
            oninput="checkAnswer()"
            onkeydown="handleKeyPress(event)"
          ></textarea>
        </div>

        <div class="button-container">
          <button
            class="btn-next"
            onclick="nextQuestion()"
            id="nextBtn"
            disabled
          >
            NEXT ‚Üí
          </button>
          <button class="btn-back" onclick="previousQuestion()" id="backBtn">
            ‚Üê BACK
          </button>
        </div>
      </div>

      <!-- Results Screen -->
      <div id="resultsScreen" class="question-card hidden">
        <div class="results" id="loadingState">
          <h2>Finding your perfect match...</h2>
          <div class="spinner"></div>
          <p style="color: #999; margin-top: 20px">
            Analyzing your musical DNA...
          </p>
        </div>

        <!-- Match Result (hidden initially) -->
        <div class="match-result hidden" id="matchResult">
          <div class="match-header">
            <h2>üéâ WE FOUND YOUR SONIC TWIN!</h2>
            <div class="similarity-badge">
              <span class="similarity-score" id="similarityScore">95%</span>
              <span class="similarity-label">MATCH</span>
            </div>
          </div>

          <div class="list-sections">
            <!-- Left Column: Demographics -->
            <div class="list-section">
              <h3>üìä Demographics</h3>
              <div class="info-item">
                <span class="info-label">Age</span>
                <span class="info-value" id="matchAge">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Gender</span>
                <span class="info-value" id="matchGender">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Location</span>
                <span class="info-value" id="matchLocation">-</span>
              </div>
            </div>

            <!-- Right Column: Music Profile -->
            <div class="list-section">
              <h3>üéµ Music DNA</h3>
              <div class="info-label">Their genre</div>
              <div class="single-value" id="matchGenre">-</div>
              <div class="info-label">Favorite Artist</div>
              <div class="single-value" id="matchFavBand">-</div>
              <div class="info-label">First Loved Artist / Song:</div>
              <div class="single-value" id="matchFirstArtist">-</div>
            </div>
          </div>

          <!-- Music Relationship -->
          <div class="quote-section">
            <h3>üí≠ Their Relationship with Music</h3>
            <div class="quote-card">
              <p id="matchRelationship">-</p>
            </div>
          </div>

          <!-- Current Vibe -->
          <div class="quote-section">
            <h3>üéß Current Vibe</h3>
            <div class="quote-card">
              <p id="matchCurrentPref">-</p>
            </div>
          </div>

          <!-- AI Opinions Grid -->
          <div class="ai-opinions">
            <h3>ü§ñ AI Music Opinions</h3>
            <div class="opinion-grid">
              <div class="opinion-card">
                <div class="opinion-title">AI-Generated Music</div>
                <div class="opinion-text" id="matchAiSongs">-</div>
              </div>
              <div class="opinion-card">
                <div class="opinion-title">Dead Artists' Voices</div>
                <div class="opinion-text" id="matchDeadArtists">-</div>
              </div>
            </div>
          </div>

          <!-- Personal Touches -->
          <div class="personal-section">
            <div class="personal-card">
              <h3>üé§ Their Life's Theme Song</h3>
              <div class="theme-song" id="matchThemeSong">-</div>
            </div>
            <div class="personal-card">
              <h3>‚ú® Favorite Lyric</h3>
              <div class="favorite-lyric" id="matchLyric">-</div>
            </div>
          </div>

          <!-- Discovery Story -->
          <div class="story-section">
            <h3>üöÄ How They Discovered Music</h3>
            <div class="story-card">
              <p id="matchDiscovery">-</p>
            </div>
          </div>

          <!-- Music Journey -->
          <div class="list-sections">
            <div class="list-section">
              <h3>üé∂ Music Discovery</h3>
              <div class="info-label">How They Find New Music</div>
              <div class="tag-container" id="matchDiscoveryMethods">
                <!-- Will be populated with tags -->
              </div>
            </div>

            <div class="list-section">
              <h3>üéß Listening Contexts</h3>
              <div class="info-label">When They Listen</div>
              <div class="tag-container" id="matchListeningContexts">
                <!-- Will be populated with tags -->
              </div>
            </div>

            <div class="list-section">
              <h3>üì§ Music Sharing</h3>
              <div class="info-label">How They Share</div>
              <div class="tag-container" id="matchSharingMethods">
                <!-- Will be populated with tags -->
              </div>
            </div>

            <div class="list-section">
              <h3>üéµ Friend Shares</h3>
              <div class="info-label">When Friends Share Music</div>
              <div class="single-value" id="matchFriendShares">-</div>
            </div>
          </div>

          <!-- Achievements Section -->
          <div class="achievements-section">
            <h3>üèÜ Music Achievements Unlocked</h3>
            <div class="achievements-grid" id="achievementsGrid">
              <!-- Achievements will be populated by JavaScript -->
            </div>
          </div>

          <!-- Guilty Pleasure -->
          <div
            class="quote-section"
            id="guiltyPleasureSection"
            style="display: none"
          >
            <h3>üòÖ Guilty Pleasure</h3>
            <div class="quote-card">
              <p id="matchGuiltyPleasure">-</p>
            </div>
          </div>

          <!-- Restart Button -->
          <div class="restart-container">
            <button class="btn-restart" onclick="location.reload()">
              FIND ANOTHER MATCH
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const questions = [
        {
          id: 1,
          question: "What's your relationship with music like?",
          placeholder:
            "e.g., 'It's my whole life' or 'I'm pretty casual about it'",
          hint: "üí° Just a sentence or two",
        },
        {
          id: 2,
          question: "How did you first discover music you loved?",
          placeholder:
            "e.g., 'My dad's vinyl collection' or 'TikTok algorithm'",
          hint: "üí° What was the gateway?",
        },
        {
          id: 3,
          question: "What kind of music are you into these days?",
          placeholder: "e.g., 'Sad girl indie' or 'Anything I can dance to'",
          hint: "üí° Vibe, genre, mood - whatever",
        },
        {
          id: 4,
          question: "Real talk - how do you feel about AI making music?",
          placeholder:
            "e.g., 'If it's good, it's good' or 'Nah, needs human soul'",
          hint: "üí° No judgment, just curious",
        },
        {
          id: 5,
          question:
            "What about AI using dead artists' voices to make new songs?",
          placeholder: "e.g., 'Kinda cool' or 'Feels wrong to me'",
          hint: "üí° First reaction is fine",
        },
        {
          id: 6,
          question: "Do you share music with people, or keep it to yourself?",
          placeholder:
            "e.g., 'Always sending songs' or 'It's my private thing'",
          hint: "üí° How social are you with your taste?",
        },
      ];

      let currentQuestion = 0;
      let answers = {};

      // Particle animation
      const canvas = document.getElementById("particles");
      const ctx = canvas.getContext("2d");
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const particleCount = 100;

      class Particle {
        constructor() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
          this.size = Math.random() * 2 + 0.5;
          this.speedX = Math.random() * 0.5 - 0.25;
          this.speedY = Math.random() * 0.5 - 0.25;
          this.opacity = Math.random() * 0.5 + 0.2;
        }

        update() {
          this.x += this.speedX;
          this.y += this.speedY;

          if (this.x > canvas.width) this.x = 0;
          if (this.x < 0) this.x = canvas.width;
          if (this.y > canvas.height) this.y = 0;
          if (this.y < 0) this.y = canvas.height;
        }

        draw() {
          ctx.fillStyle = `rgba(102, 126, 234, ${this.opacity})`;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      for (let i = 0; i < particleCount; i++) {
        particles.push(new Particle());
      }

      function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        particles.forEach((particle) => {
          particle.update();
          particle.draw();
        });

        // Draw connections
        particles.forEach((a, i) => {
          particles.slice(i + 1).forEach((b) => {
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < 100) {
              ctx.strokeStyle = `rgba(102, 126, 234, ${
                0.2 * (1 - distance / 100)
              })`;
              ctx.lineWidth = 0.5;
              ctx.beginPath();
              ctx.moveTo(a.x, a.y);
              ctx.lineTo(b.x, b.y);
              ctx.stroke();
            }
          });
        });

        requestAnimationFrame(animateParticles);
      }

      animateParticles();

      window.addEventListener("resize", () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });

      function startQuestionnaire() {
        document.getElementById("welcomeScreen").classList.add("hidden");
        document.getElementById("progressContainer").classList.remove("hidden");
        document.getElementById("questionCard").classList.remove("hidden");
        loadQuestion();
      }

      function loadQuestion() {
        const q = questions[currentQuestion];
        document.getElementById("questionNumber").textContent = `QUESTION ${
          currentQuestion + 1
        }/6`;
        document.getElementById("questionText").textContent = q.question;
        document.getElementById("questionHint").textContent = q.hint;
        document.getElementById("answerInput").placeholder = q.placeholder;

        // Load saved answer if exists
        const savedAnswer = answers[`q${q.id}`] || "";
        document.getElementById("answerInput").value = savedAnswer;

        // Update progress bar
        const progress = (currentQuestion / questions.length) * 100;
        document.getElementById("progressBar").style.width = progress + "%";

        // Update buttons
        document.getElementById("backBtn").disabled = currentQuestion === 0;
        document.getElementById("backBtn").style.opacity =
          currentQuestion === 0 ? "0.5" : "1";

        checkAnswer();
        document.getElementById("answerInput").focus();
      }

      function checkAnswer() {
        const answer = document.getElementById("answerInput").value.trim();
        document.getElementById("nextBtn").disabled = !answer;
      }

      function handleKeyPress(event) {
        if (event.key === "Enter" && event.ctrlKey) {
          if (document.getElementById("answerInput").value.trim()) {
            nextQuestion();
          }
        }
      }

      function nextQuestion() {
        const answer = document.getElementById("answerInput").value.trim();
        if (!answer) return;

        // Save answer
        answers[`q${questions[currentQuestion].id}`] = answer;

        if (currentQuestion < questions.length - 1) {
          currentQuestion++;
          loadQuestion();
        } else {
          submitAnswers();
        }
      }

      function previousQuestion() {
        if (currentQuestion > 0) {
          const answer = document.getElementById("answerInput").value.trim();
          if (answer) answers[`q${questions[currentQuestion].id}`] = answer;
          currentQuestion--;
          loadQuestion();
        }
      }

      function submitAnswers() {
        // Hide question card, show results
        document.getElementById("questionCard").classList.add("hidden");
        document.getElementById("resultsScreen").classList.remove("hidden");
        document.getElementById("progressBar").style.width = "100%";

        // Send answers to backend
        fetch("/submit_answers", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(answers),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Analyze match insights with AI
              return fetch("/analyze_match", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  user_answers: answers,
                  match_profile: data.match.profile,
                }),
              })
                .then((res) => res.json())
                .then((analysisData) => {
                  displayMatch(
                    data.match,
                    analysisData.insights || [],
                    analysisData.summary || ""
                  );
                });
            } else {
              throw new Error(data.message || "Unknown error");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            document.getElementById("loadingState").innerHTML = `
              <h2 style="color: #ff6b6b;"> Oops! Something went wrong</h2>
              <p style="color: #999; margin-top: 20px">${error.message}</p>
              <button class="btn-restart" onclick="location.reload()" style="margin-top: 30px;">
                TRY AGAIN
              </button>
            `;
          });
      }

      function displayMatch(match, insights = [], summary = "") {
        // Hide loading, show results
        setTimeout(() => {
          console.log(match);
          console.log(insights);
          document.getElementById("loadingState").classList.add("hidden");
          document.getElementById("matchResult").classList.remove("hidden");

          // Populate data
          const profile = match.profile;

          // Similarity score
          const similarityPercent = Math.round(match.similarity_score * 100);
          document.getElementById(
            "similarityScore"
          ).textContent = `${similarityPercent}%`;

          console.log(profile);

          // Field mapping for highlighting
          const fieldMap = {
            relationship_with_music: "matchRelationship",
            // "music relationship": "matchRelationship",
            discovering_music: "matchDiscovery",
            // "discovering music": "matchDiscovery",
            current_preference: "matchCurrentPref",
            // "current preference": "matchCurrentPref",
            ai_songs: "matchAiSongs",
            // "ai-generated music": "matchAiSongs",
            // "ai music": "matchAiSongs",
            dead_artists_voice: "matchDeadArtists",
            // "dead artists": "matchDeadArtists",
            discovery_methods: "matchDiscoveryMethods",
            // "discovery methods": "matchDiscoveryMethods",
            listening_contexts: "matchListeningContexts",
            // "listening contexts": "matchListeningContexts",
            music_achievements: "matchAchievements",
            achievements: "matchAchievements",
            sharing_methods: "matchSharingMethods",
            sharing: "matchSharingMethods",
            guilty_pleasure: "matchGuiltyPleasure",
            favorite_band: "matchFavBand",
            favorite_genre: "matchGenre",
            favorite_lyric: "matchLyric",
            first_song_artist_love: "matchFirstArtist",
            friend_shares_reaction: "matchFriendShares",
            guilty_pleasure_song: "matchGuiltyPleasure",
            theme_song: "matchThemeSong",
          };

          // Highlight fields mentioned in insights
          const highlightedFields = new Set();
          insights.forEach((insight) => {
            const fieldLower = insight.field.toLowerCase();
            for (const [key, elementId] of Object.entries(fieldMap)) {
              if (fieldLower.includes(key)) {
                highlightedFields.add(elementId);
              }
            }
          });

          // Demographics
          document.getElementById("matchAge").textContent =
            profile.age || "N/A";
          document.getElementById("matchGender").textContent =
            profile.gender || "N/A";
          document.getElementById("matchLocation").textContent =
            profile.location || "N/A";

          // Music DNA (with highlighting)
          // setFieldWithHighlight(
          //   "matchGenre",
          //   profile.favorite_genre,
          //   highlightedFields
          // );
          // setFieldWithHighlight(
          //   "matchFavBand",
          //   profile.favorite_band,
          //   highlightedFields
          // );
          // setFieldWithHighlight(
          //   "matchFirstArtist",
          //   profile.first_song_artist_love,
          //   highlightedFields
          // );

          // Friend shares (single value with highlighting)
          const favorite_genreEl = document.getElementById("matchGenre");
          favorite_genreEl.textContent = profile.favorite_genre || "N/A";
          if (highlightedFields.has("matchGenre")) {
            favorite_genreEl.classList.add("highlighted-single-value");
          }
          // Friend shares (single value with highlighting)
          const favorite_bandEl = document.getElementById("matchFavBand");
          favorite_bandEl.textContent = profile.favorite_band || "N/A";
          if (highlightedFields.has("matchFavBand")) {
            favorite_bandEl.classList.add("highlighted-single-value");
          }
          // Friend shares (single value with highlighting)
          const first_song_artist_loveEl =
            document.getElementById("matchFirstArtist");
          first_song_artist_loveEl.textContent =
            profile.first_song_artist_love || "N/A";
          if (highlightedFields.has("matchFirstArtist")) {
            first_song_artist_loveEl.classList.add("highlighted-single-value");
          }

          // Quotes and text (with highlighting)
          setFieldWithHighlight(
            "matchRelationship",
            profile.relationship_with_music,
            highlightedFields
          );
          setFieldWithHighlight(
            "matchCurrentPref",
            profile.current_preference,
            highlightedFields
          );
          setFieldWithHighlight(
            "matchDiscovery",
            profile.discovering_music,
            highlightedFields
          );

          // AI Opinions (with highlighting)
          setFieldWithHighlight(
            "matchAiSongs",
            profile.ai_songs,
            highlightedFields
          );
          setFieldWithHighlight(
            "matchDeadArtists",
            profile.dead_artists_voice,
            highlightedFields
          );

          // Personal (with highlighting)
          setFieldWithHighlight(
            "matchThemeSong",
            profile.theme_song,
            highlightedFields
          );
          setFieldWithHighlight(
            "matchLyric",
            profile.favorite_lyric,
            highlightedFields
          );

          // Music Journey fields (with highlighting) - display as tags
          displayTags(
            "matchDiscoveryMethods",
            profile.discovery_methods,
            highlightedFields
          );
          displayTags(
            "matchListeningContexts",
            profile.listening_contexts,
            highlightedFields
          );
          displayTags(
            "matchSharingMethods",
            profile.sharing_methods,
            highlightedFields
          );

          // Friend shares (single value with highlighting)
          const friendSharesEl = document.getElementById("matchFriendShares");
          friendSharesEl.textContent = profile.friend_shares_reaction || "N/A";
          if (highlightedFields.has("matchFriendShares")) {
            friendSharesEl.classList.add("highlighted-single-value");
          }

          // Display achievements as video game style badges
          displayAchievements(profile.music_achievements, highlightedFields);

          // Guilty Pleasure (show only if present)
          if (
            profile.guilty_pleasure_song &&
            profile.guilty_pleasure_song !== "N/A"
          ) {
            document.getElementById("guiltyPleasureSection").style.display =
              "block";
            setFieldWithHighlight(
              "matchGuiltyPleasure",
              profile.guilty_pleasure_song,
              highlightedFields
            );
          }

          // Display insights at the top
          if (insights.length > 0 || summary) {
            const summaryHTML = summary
              ? `
              <div class="match-summary">
                ${summary}
              </div>
            `
              : "";

            const insightsHTML = insights
              .map(
                (insight, idx) => `
              <div class="insight-card" style="animation-delay: ${idx * 0.1}s">
                <div class="insight-number">${idx + 1}</div>
                <div class="insight-content">
                  <div class="insight-field">${insight.field}</div>
                  <div class="insight-text">${insight.insight}</div>
                </div>
              </div>
            `
              )
              .join("");

            const insightsSection = document.createElement("div");
            insightsSection.className = "insights-section";
            insightsSection.innerHTML = `
              <h3>‚ú® Why You Match</h3>
              ${summaryHTML}
              <div class="insights-container">
                ${insightsHTML}
              </div>
            `;

            const matchResult = document.getElementById("matchResult");
            matchResult.insertBefore(insightsSection, matchResult.children[1]);
          }

          // Animate in
          document.getElementById("matchResult").style.animation =
            "fadeInUp 0.8s ease";
        }, 1500);
      }

      function setFieldWithHighlight(elementId, text, highlightedFields) {
        const element = document.getElementById(elementId);
        element.textContent = text || "N/A";

        if (highlightedFields.has(elementId)) {
          element.parentElement.classList.add("highlighted-field");
        }
      }

      function displayTags(containerId, itemsStr, highlightedFields) {
        const container = document.getElementById(containerId);

        if (!itemsStr || itemsStr === "N/A") {
          container.innerHTML = '<span class="no-data">No data</span>';
          return;
        }

        const items = itemsStr.split(",").map((item) => item.trim());
        const isHighlighted = highlightedFields.has(containerId);

        container.innerHTML = items
          .map(
            (item) => `
          <div class="tag-item ${isHighlighted ? "highlighted" : ""}">
            <span class="tag-checkbox">‚úì</span>
            <span class="tag-text">${item}</span>
          </div>
        `
          )
          .join("");
      }

      function displayAchievements(achievementsStr, highlightedFields) {
        const achievements = [
          {
            name: "Made a breakup playlists",
            image: "BreakupPlaylist.png",
            key: "breakup",
          },
          {
            name: "Played DJ on road trip",
            image: "DjOnRoadTrip.png",
            key: "dj",
          },
          {
            name: "Used music to hype themselves up",
            image: "HypeMusic.png",
            key: "hype",
          },
          {
            name: "Cried to a sad song",
            image: "CriedToSadSong.png",
            key: "cried",
          },
          {
            name: "Shared a song to flirt",
            image: "SharedSongFlirt.png",
            key: "flirt",
          },
          {
            name: "Made a playlist just for the vibes",
            image: "MadeAPlaylist.png",
            key: "vibe",
          },
          {
            name: "Replayed the same song 10+ times",
            image: "10PlusReplays.png",
            key: "replay",
          },
        ];

        const achievedList = achievementsStr
          ? achievementsStr.toLowerCase()
          : "";
        const grid = document.getElementById("achievementsGrid");

        grid.innerHTML = achievements
          .map((achievement) => {
            const unlocked = achievedList.includes(achievement.key);
            const highlighted = highlightedFields.has("matchAchievements");

            return `
            <div class="achievement-badge ${unlocked ? "unlocked" : "locked"} ${
              highlighted && unlocked ? "highlighted" : ""
            }"
                 title="${achievement.name}">
              <div class="achievement-icon">
                <img src="/static/images/${achievement.image}" alt="${
              achievement.name
            }">
              </div>
              <div class="achievement-name">${achievement.name}</div>
              ${unlocked ? '<div class="achievement-checkmark">‚úì</div>' : ""}
            </div>
          `;
          })
          .join("");
      }
    </script>
  </body>
</html>
