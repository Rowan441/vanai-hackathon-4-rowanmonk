<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Music Taste Matcher - Find Your Twin</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
  </head>
  <body>
    <div class="background"></div>
    <canvas id="particles"></canvas>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden"></div>

    <div class="container">
      <div class="header">
        <h1>üéµ MUSIC TASTE MATCHER</h1>
        <p class="subtitle">FIND YOUR SONIC TWIN</p>
      </div>

      <!-- Welcome Screen -->
      <div id="welcomeScreen" class="welcome-screen">
        <div class="question-card purple-hover">
          <h2>Ready to find your music taste twin?</h2>
          <p>
            Answer 6 quick questions and we'll match you with someone who shares
            your musical DNA.
          </p>
          <button class="btn-start" onclick="startQuestionnaire()">
            BEGIN JOURNEY
          </button>
        </div>
      </div>

      <!-- Progress Bar -->
      <div id="progressContainer" class="progress-container hidden">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <!-- Question Card -->
      <div id="questionCard" class="question-card purple-hover hidden">
        <div class="question-number" id="questionNumber">QUESTION 1/6</div>
        <div class="question-text" id="questionText"></div>
        <div class="question-hint" id="questionHint"></div>

        <div class="input-wrapper">
          <textarea
            id="answerInput"
            placeholder="Type your answer here..."
            oninput="checkAnswer()"
            onkeydown="handleKeyPress(event)"
          ></textarea>
        </div>

        <div class="button-container">
          <button
            class="btn-next"
            onclick="nextQuestion()"
            id="nextBtn"
            disabled
          >
            NEXT ‚Üí
          </button>
          <button class="btn-back" onclick="previousQuestion()" id="backBtn">
            ‚Üê BACK
          </button>
        </div>
      </div>

      <!-- User Avatar Modal -->
      <div id="userAvatarModal" class="modal hidden">
        <div class="modal-content">
          <button class="modal-close" id="closeModal">&times;</button>
          <h2>Create Your Avatar</h2>
          <p style="color: rgb(120 134 198); margin-bottom: 20px">
            Describe your appearance in a few words (max 35 characters)
          </p>

          <input
            type="text"
            id="userPhysicalDescription"
            class="modal-input"
            placeholder="e.g., 'tall woman with curly hair' or 'bearded guy with glasses'"
            maxlength="35"
          />
          <p style="color: #666; font-size: 0.85em; margin-bottom: 20px">
            <span id="charCount">0</span>/35 characters
          </p>

          <button class="btn-next" id="generateUserAvatar">
            Generate Avatar
          </button>
        </div>
      </div>

      <!-- Results Screen -->
      <div id="resultsScreen" class="question-card hidden">
        <div class="results" id="loadingState">
          <h2>Finding your perfect match...</h2>
          <div class="spinner"></div>
          <p style="color: #999; margin-top: 20px">
            Analyzing your musical DNA...
          </p>
        </div>

        <!-- Match Result (hidden initially) -->
        <div class="match-result hidden" id="matchResult">
          <div class="match-header">
            <h2>üéâ WE FOUND YOUR SONIC TWIN!</h2>
            <div class="similarity-badge">
              <span class="similarity-score" id="similarityScore">95%</span>
              <span class="similarity-label">MATCH</span>
            </div>
          </div>

          <!-- AI Avatar Section -->
          <div class="avatar-section" id="avatarSection">
            <div class="avatars-grid">
              <!-- User Avatar (Left) -->
              <div class="avatar-item">
                <h3 class="avatar-title">Your Avatar</h3>
                <div class="avatar-placeholder" id="userAvatarPlaceholder">
                  <button class="create-avatar-btn" id="createUserAvatar">
                    <span class="avatar-plus">+</span>
                    <span>Create Your Avatar</span>
                  </button>
                  <div class="avatar-loading hidden" id="userAvatarLoading">
                    <div class="spinner"></div>
                    <p>Generating avatar...</p>
                  </div>
                </div>
                <div class="avatar-container hidden" id="userAvatarContainer">
                  <img
                    id="userAvatarImage"
                    src=""
                    alt="Your AI Avatar"
                    class="avatar-image"
                  />
                  <button class="recreate-avatar-btn" id="recreateUserAvatar">
                    <span>üîÑ Recreate Avatar</span>
                  </button>
                </div>
              </div>

              <!-- Match Avatar (Right) -->
              <div class="avatar-item">
                <h3 class="avatar-title">Your Match's Avatar</h3>
                <div class="avatar-loading" id="matchAvatarLoading">
                  <div class="spinner"></div>
                  <p>Generating avatar...</p>
                </div>
                <div class="avatar-container hidden" id="matchAvatarContainer">
                  <img
                    id="matchAvatarImage"
                    src=""
                    alt="Match's AI Avatar"
                    class="avatar-image"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="list-sections">
            <!-- Left Column: Demographics -->
            <div class="list-section">
              <h3>üìä Demographics</h3>
              <div class="info-item">
                <span class="info-label">Age</span>
                <span class="info-value" id="matchAge">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Gender</span>
                <span class="info-value" id="matchGender">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Location</span>
                <span class="info-value" id="matchLocation">-</span>
              </div>
            </div>

            <!-- Right Column: Music Profile -->
            <div class="list-section">
              <h3>üéµ Music DNA</h3>
              <div class="info-label">‚ú® Their genre ‚ú®</div>
              <div class="single-value" id="matchGenre">-</div>
              <div class="info-label">‚ú® Favorite Artist ‚ú®</div>
              <div class="single-value" id="matchFavBand">-</div>
              <div class="info-label">First Loved Artist / Song:</div>
              <div class="single-value quote-value" id="matchFirstArtist">
                -
              </div>
            </div>
          </div>

          <!-- Personal Touches -->
          <div class="quote-section">
            <h3>Their Life's Theme Song</h3>
            <div class="quote-card">
              <p class="theme-song" id="matchThemeSong">-</p>
            </div>
            <h3>Favorite Lyric</h3>
            <div class="quote-card">
              <p class="favorite-lyric" id="matchLyric">-</p>
            </div>
          </div>

          <!-- Guilty Pleasure -->
          <div
            class="quote-section"
            id="guiltyPleasureSection"
            style="display: none"
          >
            <h3>üòÖ Guilty Pleasure</h3>
            <div class="quote-card">
              <p id="matchGuiltyPleasure">-</p>
            </div>
          </div>

          <!-- AI Opinions Grid -->
          <div class="ai-opinions">
            <h3>ü§ñ AI Music Opinions</h3>
            <div class="opinion-grid">
              <div class="opinion-card">
                <div class="opinion-title">Listening to AI-Generated Music</div>
                <div class="opinion-text" id="matchAiSongs">-</div>
              </div>
              <div class="opinion-card">
                <div class="opinion-title">
                  Replicating Dead Artists' Voices
                </div>
                <div class="opinion-text" id="matchDeadArtists">-</div>
              </div>
            </div>
          </div>

          <!-- Music Relationship -->
          <div class="story-section">
            <h3>üí≠ Their Relationship with Music</h3>
            <div class="story-card">
              <p id="matchRelationship">-</p>
            </div>
          </div>

          <!-- Current Vibe -->
          <div class="story-section">
            <h3>üéß Current Vibe</h3>
            <div class="story-card">
              <p id="matchCurrentPref">-</p>
            </div>
          </div>

          <!-- Discovery Story -->
          <div class="story-section">
            <h3>üöÄ How They Discovered Music</h3>
            <div class="story-card">
              <p id="matchDiscovery">-</p>
            </div>
          </div>

          <!-- Music Journey -->
          <div class="list-sections">
            <div class="list-section">
              <h3>üé∂ Music Discovery</h3>
              <div class="info-label">How They Find New Music</div>
              <div class="tag-container" id="matchDiscoveryMethods">
                <!-- Will be populated with tags -->
              </div>
            </div>

            <div class="list-section">
              <h3>üéß Listening Contexts</h3>
              <div class="info-label">When They Listen</div>
              <div class="tag-container" id="matchListeningContexts">
                <!-- Will be populated with tags -->
              </div>
            </div>

            <div class="list-section">
              <h3>üì§ Music Sharing</h3>
              <div class="info-label">How They Share</div>
              <div class="tag-container" id="matchSharingMethods">
                <!-- Will be populated with tags -->
              </div>
            </div>

            <div class="list-section">
              <h3>üéµ Friend Shares</h3>
              <div class="info-label">When Friends Share Music</div>
              <div class="single-value" id="matchFriendShares">-</div>
            </div>
          </div>

          <!-- Achievements Section -->
          <div class="achievements-section" id="matchAchievements">
            <h3>üèÜ Music Achievements</h3>
            <div class="achievements-grid" id="achievementsGrid">
              <!-- Achievements will be populated by JavaScript -->
            </div>
          </div>

          <!-- Restart Button -->
          <div class="restart-container">
            <button class="btn-restart" onclick="location.reload()">
              FIND ANOTHER MATCH
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const questions = [
        {
          id: 1,
          question: "What's your relationship with music like?",
          placeholder:
            "e.g., 'It's my whole life' or 'I'm pretty casual about it'",
          hint: "üí° Just a sentence or two",
        },
        {
          id: 2,
          question: "How did you first discover music you loved?",
          placeholder:
            "e.g., 'My dad's vinyl collection' or 'TikTok algorithm'",
          hint: "üí° What was the gateway?",
        },
        {
          id: 3,
          question: "What kind of music are you into these days?",
          placeholder: "e.g., 'Sad girl indie' or 'Anything I can dance to'",
          hint: "üí° Vibe, genre, specific artists - whatever",
        },
        {
          id: 4,
          question: "Real talk - how do you feel about AI making music?",
          placeholder:
            "e.g., 'If it's good, it's good' or 'Nah, needs human soul'",
          hint: "üí° No judgment, just curious",
        },
        {
          id: 5,
          question: "In what situations are you listening music the most?",
          placeholder: "e.g., 'While cooking dinner' or 'At the gym'",
          hint: "üí° Think about your daily routine - when do you reach for your headphones?",
        },
        {
          id: 6,
          question:
            "What is your absolute favourite band / artist and what do you love about them?",
          placeholder:
            "e.g., 'Radiohead - their creativity never stops' or 'Taylor Swift - I grew up with her'",
          hint: "üí° Who's your #1 and why do they mean so much to you?",
        },
      ];

      let currentQuestion = 0;
      let answers = {};

      // Particle animation
      const canvas = document.getElementById("particles");
      const ctx = canvas.getContext("2d");
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const particleCount = 100;

      class Particle {
        constructor() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
          this.size = Math.random() * 2 + 0.5;
          this.speedX = Math.random() * 0.5 - 0.25;
          this.speedY = Math.random() * 0.5 - 0.25;
          this.opacity = Math.random() * 0.5 + 0.2;
        }

        update() {
          this.x += this.speedX;
          this.y += this.speedY;

          if (this.x > canvas.width) this.x = 0;
          if (this.x < 0) this.x = canvas.width;
          if (this.y > canvas.height) this.y = 0;
          if (this.y < 0) this.y = canvas.height;
        }

        draw() {
          ctx.fillStyle = `rgba(102, 126, 234, ${this.opacity})`;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      for (let i = 0; i < particleCount; i++) {
        particles.push(new Particle());
      }

      function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        particles.forEach((particle) => {
          particle.update();
          particle.draw();
        });

        // Draw connections
        particles.forEach((a, i) => {
          particles.slice(i + 1).forEach((b) => {
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < 100) {
              ctx.strokeStyle = `rgba(102, 126, 234, ${
                0.2 * (1 - distance / 100)
              })`;
              ctx.lineWidth = 0.5;
              ctx.beginPath();
              ctx.moveTo(a.x, a.y);
              ctx.lineTo(b.x, b.y);
              ctx.stroke();
            }
          });
        });

        requestAnimationFrame(animateParticles);
      }

      animateParticles();

      window.addEventListener("resize", () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });

      // Toast notification function
      function showToast(message, type = 'error') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.remove('hidden');

        // Auto-hide after 5 seconds
        setTimeout(() => {
          toast.classList.add('hidden');
        }, 5000);
      }

      function startQuestionnaire() {
        document.getElementById("welcomeScreen").classList.add("hidden");
        document.getElementById("progressContainer").classList.remove("hidden");
        document.getElementById("questionCard").classList.remove("hidden");
        loadQuestion();
      }

      function loadQuestion() {
        const q = questions[currentQuestion];
        document.getElementById("questionNumber").textContent = `QUESTION ${
          currentQuestion + 1
        }/6`;
        document.getElementById("questionText").textContent = q.question;
        document.getElementById("questionHint").textContent = q.hint;
        document.getElementById("answerInput").placeholder = q.placeholder;

        // Load saved answer if exists
        const savedAnswer = answers[`q${q.id}`] || "";
        document.getElementById("answerInput").value = savedAnswer;

        // Update progress bar
        const progress = (currentQuestion / questions.length) * 100;
        document.getElementById("progressBar").style.width = progress + "%";

        // Update buttons
        document.getElementById("backBtn").disabled = currentQuestion === 0;
        document.getElementById("backBtn").style.opacity =
          currentQuestion === 0 ? "0.5" : "1";

        checkAnswer();
        document.getElementById("answerInput").focus();
      }

      function checkAnswer() {
        const answer = document.getElementById("answerInput").value.trim();
        document.getElementById("nextBtn").disabled = !answer;
      }

      function handleKeyPress(event) {
        if (event.key === "Enter" && event.ctrlKey) {
          if (document.getElementById("answerInput").value.trim()) {
            nextQuestion();
          }
        }
      }

      function nextQuestion() {
        const answer = document.getElementById("answerInput").value.trim();
        if (!answer) return;

        // Save answer
        answers[`q${questions[currentQuestion].id}`] = answer;

        if (currentQuestion < questions.length - 1) {
          currentQuestion++;
          loadQuestion();
        } else {
          submitAnswers();
        }
      }

      function previousQuestion() {
        if (currentQuestion > 0) {
          const answer = document.getElementById("answerInput").value.trim();
          if (answer) answers[`q${questions[currentQuestion].id}`] = answer;
          currentQuestion--;
          loadQuestion();
        }
      }

      function submitAnswers() {
        // Hide question card, show results
        document.getElementById("questionCard").classList.add("hidden");
        document.getElementById("resultsScreen").classList.remove("hidden");
        document.getElementById("progressBar").style.width = "100%";

        // Send answers to backend
        fetch("/submit_answers", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(answers),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Analyze match insights with AI
              return fetch("/analyze_match", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  user_answers: answers,
                  match_profile: data.match.profile,
                }),
              })
                .then((res) => res.json())
                .then((analysisData) => {
                  displayMatch(
                    data.match,
                    analysisData.insights || [],
                    analysisData.summary || ""
                  );

                  // Generate AI avatar
                  generateAvatar(data.match.participant_id);
                });
            } else {
              throw new Error(data.message || "Unknown error");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            document.getElementById("loadingState").innerHTML = `
              <h2 style="color: #ff6b6b;"> Oops! Something went wrong</h2>
              <p style="color: #999; margin-top: 20px">${error.message}</p>
              <button class="btn-restart" onclick="location.reload()" style="margin-top: 30px;">
                TRY AGAIN
              </button>
            `;
          });
      }

      function displayMatch(match, insights = [], summary = "") {
        // Hide loading, show results
        setTimeout(() => {
          document.getElementById("loadingState").classList.add("hidden");
          document.getElementById("matchResult").classList.remove("hidden");

          // Populate data
          const profile = match.profile;

          // Similarity score
          const similarityPercent = Math.round(match.similarity_score * 100);
          document.getElementById(
            "similarityScore"
          ).textContent = `${similarityPercent}%`;

          // Field mapping for highlighting
          const fieldMap = {
            relationship_with_music: "matchRelationship",
            // "music relationship": "matchRelationship",
            discovering_music: "matchDiscovery",
            // "discovering music": "matchDiscovery",
            current_preference: "matchCurrentPref",
            // "current preference": "matchCurrentPref",
            ai_songs: "matchAiSongs",
            // "ai-generated music": "matchAiSongs",
            // "ai music": "matchAiSongs",
            dead_artists_voice: "matchDeadArtists",
            // "dead artists": "matchDeadArtists",
            discovery_methods: "matchDiscoveryMethods",
            // "discovery methods": "matchDiscoveryMethods",
            listening_contexts: "matchListeningContexts",
            // "listening contexts": "matchListeningContexts",
            music_achievements: "matchAchievements",
            sharing_methods: "matchSharingMethods",
            sharing: "matchSharingMethods",
            guilty_pleasure: "matchGuiltyPleasure",
            favorite_band: "matchFavBand",
            favorite_genre: "matchGenre",
            favorite_lyric: "matchLyric",
            first_song_artist_love: "matchFirstArtist",
            friend_shares_reaction: "matchFriendShares",
            guilty_pleasure_song: "matchGuiltyPleasure",
            theme_song: "matchThemeSong",
          };

          // Highlight fields mentioned in insights
          const highlightedFields = new Set();
          insights.forEach((insight) => {
            const fieldLower = insight.field.toLowerCase();
            for (const [key, elementId] of Object.entries(fieldMap)) {
              if (fieldLower.includes(key)) {
                highlightedFields.add(elementId);
              }
            }
          });

          // Demographics
          document.getElementById("matchAge").textContent =
            profile.age || "N/A";
          document.getElementById("matchGender").textContent =
            profile.gender || "N/A";
          document.getElementById("matchLocation").textContent =
            profile.location || "N/A";

          // Friend shares (single value with highlighting)
          const favorite_genreEl = document.getElementById("matchGenre");
          favorite_genreEl.textContent = profile.favorite_genre || "N/A";
          if (highlightedFields.has("matchGenre")) {
            favorite_genreEl.classList.add("highlighted-single-value");
          }
          // Friend shares (single value with highlighting)
          const favorite_bandEl = document.getElementById("matchFavBand");
          favorite_bandEl.textContent = profile.favorite_band || "N/A";
          if (highlightedFields.has("matchFavBand")) {
            favorite_bandEl.classList.add("highlighted-single-value");
          }
          // Friend shares (single value with highlighting)
          const first_song_artist_loveEl =
            document.getElementById("matchFirstArtist");
          first_song_artist_loveEl.innerHTML =
            profile.first_song_artist_love || "N/A";
          if (highlightedFields.has("matchFirstArtist")) {
            first_song_artist_loveEl.classList.add("highlighted-single-value");
          }

          // Quotes and text (with highlighting)
          setFieldWithHighlight(
            "matchRelationship",
            profile.relationship_with_music,
            highlightedFields
          );
          setFieldWithHighlight(
            "matchCurrentPref",
            profile.current_preference,
            highlightedFields
          );
          setFieldWithHighlight(
            "matchDiscovery",
            profile.discovering_music,
            highlightedFields
          );

          // AI Opinions (with highlighting)
          setFieldWithHighlight(
            "matchAiSongs",
            profile.ai_songs,
            highlightedFields
          );
          setFieldWithHighlight(
            "matchDeadArtists",
            profile.dead_artists_voice,
            highlightedFields
          );

          // Personal (with highlighting)
          setFieldWithHighlight(
            "matchThemeSong",
            profile.theme_song,
            highlightedFields
          );
          setFieldWithHighlight(
            "matchLyric",
            profile.favorite_lyric,
            highlightedFields
          );

          // Music Journey fields (with highlighting) - display as tags
          displayTags(
            "matchDiscoveryMethods",
            profile.discovery_methods,
            highlightedFields
          );
          displayTags(
            "matchListeningContexts",
            profile.listening_contexts,
            highlightedFields
          );
          displayTags(
            "matchSharingMethods",
            profile.sharing_methods,
            highlightedFields
          );

          // Friend shares (single value with highlighting)
          const friendSharesEl = document.getElementById("matchFriendShares");
          friendSharesEl.textContent = profile.friend_shares_reaction || "N/A";
          if (highlightedFields.has("matchFriendShares")) {
            friendSharesEl.classList.add("highlighted-single-value");
          }

          // Display achievements as video game style badges
          displayAchievements(profile.music_achievements, highlightedFields);

          // Guilty Pleasure (show only if present)
          if (
            profile.guilty_pleasure_song &&
            profile.guilty_pleasure_song !== "N/A"
          ) {
            document.getElementById("guiltyPleasureSection").style.display =
              "block";
            setFieldWithHighlight(
              "matchGuiltyPleasure",
              profile.guilty_pleasure_song,
              highlightedFields
            );
          }

          // Display summary and margin note insights
          if (summary || insights.length > 0) {
            // Add summary at the top if present
            if (summary) {
              const summarySection = document.createElement("div");
              summarySection.className = "insights-section";
              summarySection.innerHTML = `
                <h3>‚ú® Why You Match ‚ú®</h3>
                <div class="match-summary">${summary}</div>
              `;
              const matchResult = document.getElementById("matchResult");
              matchResult.insertBefore(summarySection, matchResult.children[1]);
            }

            // Place insights as margin notes next to their fields
            insights.forEach((insight, idx) => {
              const fieldLower = insight.field.toLowerCase();
              let targetElementId = null;

              // Find the matching element ID
              for (const [key, elementId] of Object.entries(fieldMap)) {
                if (fieldLower.includes(key)) {
                  targetElementId = elementId;
                  break;
                }
              }

              if (targetElementId) {
                const targetElement = document.getElementById(targetElementId);
                if (targetElement) {
                  // Create margin note
                  const marginNote = document.createElement("div");
                  marginNote.className = "margin-note";
                  marginNote.style.animationDelay = `${idx * 0.1}s`;
                  marginNote.innerHTML = `
                    <button class="margin-note-close" title="Dismiss">‚úï</button>
                    <div class="margin-note-content">
                      <div class="margin-note-text">‚ú® ${insight.insight} ‚ú®</div>
                    </div>
                  `;

                  // Add close button handler
                  marginNote
                    .querySelector(".margin-note-close")
                    .addEventListener("click", function (e) {
                      e.stopPropagation();
                      marginNote.remove();
                    });

                  // Find the parent container to add relative positioning
                  let container = targetElement.closest(
                    ".quote-card, .opinion-card, .personal-card, .story-card, .single-value, .list-section, .achievements-section"
                  );
                  if (container) {
                    container.style.position = "relative";

                    // Determine if container is in left or right column
                    const rect = container.getBoundingClientRect();
                    const viewportCenter = window.innerWidth / 2;
                    const containerCenter = rect.left + rect.width / 2;

                    if (containerCenter < viewportCenter) {
                      // Left side - put note on left margin
                      marginNote.classList.add("margin-note-left");
                    }

                    container.appendChild(marginNote);
                  }
                }
              }
            });
          }

          // Animate in
          document.getElementById("matchResult").style.animation =
            "fadeInUp 0.8s ease";
        }, 1500);
      }

      function setFieldWithHighlight(elementId, text, highlightedFields) {
        const element = document.getElementById(elementId);
        element.innerHTML = text || "N/A";

        if (highlightedFields.has(elementId)) {
          element.parentElement.classList.add("highlighted-field");
        }
      }

      function displayTags(containerId, itemsStr, highlightedFields) {
        const container = document.getElementById(containerId);

        if (!itemsStr || itemsStr === "N/A") {
          container.innerHTML = '<span class="no-data">No data</span>';
          return;
        }

        const items = itemsStr.split(",").map((item) => item.trim());
        const isHighlighted = highlightedFields.has(containerId);

        if (isHighlighted) {
          const listSection = container.closest(".list-section");
          if (listSection) {
            listSection.classList.add("highlighted-field");
          }
        }

        container.innerHTML = items
          .map((item) => {
            const itemLower = item.toLowerCase();
            const noCheckbox =
              itemLower.includes("just replays their favourites") ||
              itemLower.includes("doesn't share music");

            return `
          <div class="tag-item ${noCheckbox ? "no-checkbox" : ""}">
            ${noCheckbox ? "" : '<span class="tag-checkbox">‚úì</span>'}
            <span class="tag-text">${item}</span>
          </div>
        `;
          })
          .join("");
      }

      function displayAchievements(achievementsStr, highlightedFields) {
        const achievements = [
          {
            name: "Made a breakup playlists",
            image: "BreakupPlaylist.png",
            key: "breakup",
          },
          {
            name: "Played DJ on road trip",
            image: "DjOnRoadTrip.png",
            key: "dj",
          },
          {
            name: "Used music to hype themselves up",
            image: "HypeMusic.png",
            key: "hype",
          },
          {
            name: "Cried to a sad song",
            image: "CriedToSadSong.png",
            key: "cried",
          },
          {
            name: "Shared a song to flirt",
            image: "SharedSongFlirt.png",
            key: "flirt",
          },
          {
            name: "Made a playlist just for the vibes",
            image: "MadeAPlaylist.png",
            key: "vibe",
          },
          {
            name: "Replayed the same song 10+ times",
            image: "10PlusReplays.png",
            key: "replay",
          },
        ];

        const achievedList = achievementsStr
          ? achievementsStr.toLowerCase()
          : "";
        const grid = document.getElementById("achievementsGrid");
        const highlighted = highlightedFields.has("matchAchievements");

        if (highlighted) {
          const achievementsSection = grid.closest(".achievements-section");
          if (achievementsSection) {
            achievementsSection.classList.add("highlighted-field");
          }
        }

        grid.innerHTML = achievements
          .map((achievement) => {
            const unlocked = achievedList.includes(achievement.key);

            return `
            <div class="achievement-badge ${unlocked ? "unlocked" : "locked"}"
                 title="${achievement.name}">
              <div class="achievement-icon">
                <img src="/static/images/${achievement.image}" alt="${
              achievement.name
            }">
              </div>
              <div class="achievement-name">${achievement.name}</div>
              ${unlocked ? '<div class="achievement-checkmark">‚úì</div>' : ""}
            </div>
          `;
          })
          .join("");
      }

      function generateAvatar(participantId) {
        // Show loading state for match avatar
        document
          .getElementById("matchAvatarLoading")
          .classList.remove("hidden");
        document.getElementById("matchAvatarContainer").classList.add("hidden");

        fetch("/generate_avatar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ participant_id: participantId }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Hide loading, show match avatar
              document
                .getElementById("matchAvatarLoading")
                .classList.add("hidden");
              document
                .getElementById("matchAvatarContainer")
                .classList.remove("hidden");

              // Set image and caption
              document.getElementById("matchAvatarImage").src = data.image_url;
              document.getElementById("matchAvatarPrompt").textContent =
                data.prompt;
            } else {
              // Show error in match avatar section
              document.getElementById("matchAvatarLoading").innerHTML =
                '<p style="color: #ff6b6b;">Failed to generate avatar</p>';
              console.error("Avatar generation failed:", data.message);
            }
          })
          .catch((error) => {
            // Show error in match avatar section
            document.getElementById("matchAvatarLoading").innerHTML =
              '<p style="color: #ff6b6b;">Error generating avatar</p>';
            console.error("Error generating avatar:", error);
          });
      }

      // User avatar creation modal handlers
      document
        .getElementById("createUserAvatar")
        ?.addEventListener("click", function () {
          document.getElementById("userAvatarModal").classList.remove("hidden");
        });

      document
        .getElementById("closeModal")
        ?.addEventListener("click", function () {
          document.getElementById("userAvatarModal").classList.add("hidden");
        });

      // Close modal on outside click
      document
        .getElementById("userAvatarModal")
        ?.addEventListener("click", function (e) {
          if (e.target.id === "userAvatarModal") {
            document.getElementById("userAvatarModal").classList.add("hidden");
          }
        });

      // Character counter for physical description
      document
        .getElementById("userPhysicalDescription")
        ?.addEventListener("input", function () {
          const length = this.value.length;
          document.getElementById("charCount").textContent = length;
        });

      // Generate user avatar
      function generateUserAvatarFromModal() {
        const physicalDesc = document
          .getElementById("userPhysicalDescription")
          .value.trim();

        if (!physicalDesc) {
          showToast("Please describe your appearance", "error");
          return;
        }

        if (physicalDesc.length > 35) {
          showToast("Description must be 35 characters or less", "error");
          return;
        }

        // Close modal immediately
        document.getElementById("userAvatarModal").classList.add("hidden");
        document.getElementById("userPhysicalDescription").value = "";
        document.getElementById("charCount").textContent = "0";

        // Hide button, show loading in placeholder
        document.getElementById("createUserAvatar").classList.add("hidden");
        document.getElementById("userAvatarLoading").classList.remove("hidden");

        fetch("/generate_user_avatar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            physical_description: physicalDesc,
            user_answers: answers,
          }),
        })
          .then((response) => {
            // Check if response is ok (200-299)
            if (!response.ok) {
              return response.json().then(err => {
                throw new Error(err.message || 'Avatar generation failed');
              });
            }
            return response.json();
          })
          .then((data) => {
            if (data.status === "success") {
              // Hide placeholder, show avatar
              document.getElementById("userAvatarPlaceholder").classList.add("hidden");
              document.getElementById("userAvatarContainer").classList.remove("hidden");

              // Set image
              document.getElementById("userAvatarImage").src = data.image_url;

              showToast("Avatar created successfully! üéâ", "success");
            }
          })
          .catch((error) => {
            // Show error toast and reset to button state
            const errorMsg = error.message || "Error generating avatar. Please try again.";
            showToast(errorMsg, "error");

            // Reset to initial state
            document.getElementById("userAvatarLoading").classList.add("hidden");
            document.getElementById("createUserAvatar").classList.remove("hidden");
          });
      }

      document
        .getElementById("generateUserAvatar")
        ?.addEventListener("click", generateUserAvatarFromModal);

      // Recreate avatar button
      document
        .getElementById("recreateUserAvatar")
        ?.addEventListener("click", function() {
          // Show modal to recreate
          document.getElementById("userAvatarModal").classList.remove("hidden");
        });
    </script>
  </body>
</html>
